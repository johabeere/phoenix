![pheonix logo](/assets/transparent_logo.png)
# Software
This part of the project includes all software running on the onboard SBC (<a href="https://www.raspberrypi.com/products/raspberry-pi-4-model-b/">Raspberry Pi 4B</a>)
## Documentation of File Structure:
 
| **File:**     | **Purpose:**                                                                                                              | **Interacts with:**                                          |
|----------------|----------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
| `install.sh`   | Used to perform initial setup. Creates the virtual environment, installs system packages and installs needed python files. | parses `requirements` to the pip module for installation.     |
| `start.sh`     | Used to start the software.Sources the venv before starting python.                                                        | Calls on `Main.py`                                            |
| `config.yaml`  | Used to configure system settings, for details see below.                                                                  | Is accessed via ``Heper.py``                                  |
| `Main.py`      | Main script of the project. Includes all other `.py` files.                                                                | uses methods from all `.py` files                             |
| `Camera.py`    | Bundles all functions related to the physical camera.                                                                      | Included in `Main.py` and `Vision.py`                         |
| `Vision.py`    | Handles all Computer Vision tasks.                                                                                         | called upon by `Main.py`                                      |
| `Hardware.py`  | Accesses all physical functions of the electronics board.                                                                  | called upon by `Main.py`                                      |
| `Helper.py`    | Common Helper file included in all other `.py` files. Implements common logging functions, etc.                            | included in every `.py` file, handles access to `config.yaml` |
| `requirements` | autogenerated file that contains all required python packages for the other scripts.                                       | Gets parsed to `pip` via `install.sh`                         |
|                |                                                                                                                            |                                                               |
## Configuration options: 
You can change these in `./phoenix/software/config.yaml`. They are devided into the following sections: 
### Vision:
| Option:               | Valid Range:                                                             | Description:                                                                                   |
|-----------------------|--------------------------------------------------------------------------|------------------------------------------------------------------------------------------------|
| ``logcolor``          | Any Colorama Color String                                                | Log color associated with this script.                                                         |
| ``tag_size``          | any ``float``                                                            | Side length of the physical Apriltag in meters.                                                |
| ``K``                 | any K calibration matrix                                                 | don't worry about this, automatically generated by launching ``$ python Vision.py``            |
| ``tag_to_search_for`` | any ``int`` associated with a tag.                                       | What Apriltag the software should look for. Will ignore all others.                            |
| ``center``            | any 2 positional ``float array`` inside the image coordinate system.     | used to define the image center. In almost all cases ``[0,0]``                                 |
| ``centerborders``     | any 2 positional ``float array`` with values between ``0.0`` and ``1.0`` | img percentages to consider 'centered'. if apriltag center is inside here, drop will commence. |
| ``target_threshold``  | any ``float`` between ``0.0`` and ``1.0``.                               | Acceptable target threshold to consider hit.                                                   |

### Camera:
| Option:                 | Valid Range:                                          | Description:                                                                                                                                                                     |
|-------------------------|-------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ``logcolor``            | Any Colorama Color String                             | Log color associated with this script.                                                                                                                                           |
| ``sensor_mode``          | Any ``int`` associated with a rpicam sensor mode.                           | Specifies the sensor mode.                                                                                                                                              |
| ``resolution``          | Any two index``int array``                            | Resolution the image capturing and computer vision system uses.                                                                                                                                              |
| ``frame_rate``          | Any ``int`` in ``0 to 60``                            | Framerate to set the Camerafeed to.                                                                                                                                              |
| ``calibrated``          | ``bool``                                              | Set this to ``true`` if your camera is calibrated.                                                                                                                               |
| ``imagepath``           | any local or global folder path with user permissions | this is the folder the code will store images in.                                                                                                                                |
| ``libcameraloglevel``   | any ``int`` associated with a tag.                    | Loglevel given to the libcamera library.                                                                                                                                         |
| ``focal_length_pixels`` | unused.                                               | unused.                                                                                                                                                                          |
| ``frame_rate``          | Any ``int`` in ``0 to 60``                            | Framerate to set the Camerafeed to.                                                                                                                                              |
| ``physical``            | any ``array`` with valid values.                      | Array to define the cameras physical attributes. Preset for the Raspberry Pi Camera Module v3. Order is: [Focal length in mm, pixels/mm for imgsize, image size x, image size y] |

### Helper:
| Option:      | Valid Range:               | Description:                           |
|--------------|----------------------------|----------------------------------------|
| ``logcolor`` | Any Colorama Color String. | Log color associated with this script. |

### Main:
| Option:           | Valid Range:               | Description:                                                 |
|-------------------|----------------------------|--------------------------------------------------------------|
| ``logcolor``      | Any Colorama Color String. | Log color associated with this script.                       |
| ``fire_polling``  | any ``float``<5            | Time interval in ``s``to look for a new fire. default: ``1`` |
| ``afterrun_time`` | any ``float``              | Time in ``s``the script should run after payload was dropped |
| ``coolmode``      | any ``bool``               | Leave this turned on for a cooler startup message ;)         |
| ``polling_timer`` | any ``float``              | Time interval in ``s`` to update sensor values.              |

### Hardware:
| Option:               | Valid Range:                                                                     | Description:                                                                      |
|-----------------------|----------------------------------------------------------------------------------|-----------------------------------------------------------------------------------|
| ``logcolor``          | Any Colorama Color String.                                                       | Log color associated with this script.                                            |
| ``camera_downtilt``   | any ``float``<5                                                                  | physical tilt angle of the camera. Was used for gyro implementation, now unused.  |
| ``accellwaitpolling`` | any ``float``                                                                    | how quickly to poll for takeoff, ``s``.                                           |
| ``zaccell``           | any ``bool``                                                                     | Threshold to detect a liftoff. Without gyro unused.                               |
| ``pumpinterval``      | any ``float``                                                                    | Time interval in ``s`` to activate the pump for payload acquisition.              |
| ``drop_servo``        | ``Literal [1, 2]``                                                               | Which servo to actuate for dropping the payload                                   |
| ``drop_position``     | any ```float`` valid PWM dutycycle %:                                            | Which position the servo should move to during drop.                              |
| ``flying_position``   | any ``float`` valid PWM dutycycle %:                                            | Which position the drop servo should take when flying.                            |
| ``mounting_position`` | any ``float`` valid PWM dutycycle %:                                            | Servo position the drop servo should take during the mounting position.           |
| ``cam_servo``         | ``Literal [1, 2]``                                                               | Which servo to actuate for rotating the camera                                    |
| ``camservo_angles``   | any ``array`` with the two angular endpositions of the camera apparatus. Unused. | Endpositions of servo motion for physical camera apperatus                        |

### User: 
| Option:       | Valid Range:        | Description:                                                                                          |
|---------------|---------------------|-------------------------------------------------------------------------------------------------------|
| ``debug``     | any ``bool``        | if true, adds printstatemens and adds more saved images.                                              |
| ``log_level`` | ``int`` from 0 to 4 | Specifies the verbosity of the CLI Output. Regardless of this, all statements are printed to the log. |

### \_\_main\_\_: 
| Option:      | Valid Range:               | Description:                           |
|--------------|----------------------------|----------------------------------------|
| ``logcolor`` | Any Colorama Color String. | Log color associated with this script. |